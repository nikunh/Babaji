---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2api
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2api
    spec:
      containers:
      - name: st2api
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2api
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }
        ports:
        - containerPort: 9101
        volumeMounts:
        - name: st2-packs-fs-env
          mountPath: /opt/stackstorm/packs
        - name: st2-config-fs-env
          mountPath: /opt/stackstorm/configs  
        - name: st2-entrypointd-fs-env
          mountPath: /st2-docker/entrypoint.d  
        - name: st2-st2d-fs-env
          mountPath: /st2-docker/st2.d  
      volumes:
      - name: st2-packs-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs 
            clusterName: rook
            path: st2-packs-fs-env
      - name: st2-config-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook  
            path: st2-config-fs-env
      - name: st2-st2d-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook 
            path: st2-st2d-fs-env
      - name: st2-entrypointd-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook 
            path: st2-entrypointd-fs-env

---
kind: Service
apiVersion: v1
metadata:
  name: st2api
  namespace: st2stack
spec:
  selector:
    app: st2api
  type: LoadBalancer
  ports:
  - protocol: TCP
    port: 9101
    targetPort: 9101

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2auth
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2auth
    spec:
      containers:
      - name: st2auth
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2auth
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }
        ports:
        - containerPort: 9100

---
kind: Service
apiVersion: v1
metadata:
  name: st2auth
  namespace: st2stack
spec:
  selector:
    app: st2auth
  type: LoadBalancer
  ports:
  - protocol: TCP
    port: 9100
    targetPort: 9100

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2stream
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2stream
    spec:
      containers:
      - name: st2stream
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2stream
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }
        ports:
        - containerPort: 9102

---
kind: Service
apiVersion: v1
metadata:
  name: st2stream
  namespace: st2stack
spec:
  selector:
    app: st2stream
  ports:
  - protocol: TCP
    port: 9102

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2sensorcontainer
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2sensorcontainer
    spec:
      containers:
      - name: st2sensorcontainer
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2sensorcontainer
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }
        volumeMounts:
        - name: st2-packs-fs-env
          mountPath: /opt/stackstorm/packs
        - name: st2-virtual-fs-env
          mountPath: /opt/stackstorm/virtualenvs
        - name: st2-config-fs-env
          mountPath: /opt/stackstorm/configs  
        - name: st2-entrypointd-fs-env
          mountPath: /st2-docker/entrypoint.d  
        - name: st2-st2d-fs-env
          mountPath: /st2-docker/st2.d  
      volumes:
      - name: st2-virtual-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook
            path: st2-virtual-fs-env
      - name: st2-packs-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs 
            clusterName: rook 
            path: st2-packs-fs-env
      - name: st2-config-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook  
            path: st2-config-fs-env
      - name: st2-st2d-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook 
            path: st2-st2d-fs-env
      - name: st2-entrypointd-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook 
            path: st2-entrypointd-fs-env

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2rulesengine
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2rulesengine
    spec:
      containers:
      - name: st2rulesengine
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2rulesengine
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2actionrunner
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2actionrunner
    spec:
      containers:
      - name: st2actionrunner
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2actionrunner
        - name: ST2_ACTION_AUTH_URL
          value: http://st2auth:9100/
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }
        volumeMounts:
        - name: st2-packs-fs-env
          mountPath: /opt/stackstorm/packs
        - name: st2-virtual-fs-env
          mountPath: /opt/stackstorm/virtualenvs
        - name: st2-config-fs-env
          mountPath: /opt/stackstorm/configs  
        - name: st2-entrypointd-fs-env
          mountPath: /st2-docker/entrypoint.d  
        - name: st2-st2d-fs-env
          mountPath: /st2-docker/st2.d  
      volumes:
      - name: st2-virtual-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs 
            clusterName: rook 
            path: st2-virtual-fs-env
      - name: st2-packs-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs 
            clusterName: rook 
            path: st2-packs-fs-env
      - name: st2-config-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook  
            path: st2-config-fs-env
      - name: st2-st2d-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook 
            path: st2-st2d-fs-env
      - name: st2-entrypointd-fs-env
        flexVolume:
          driver: rook.io/rook
          fsType: ceph
          options:
            fsName: st2stack-shared-fs
            clusterName: rook 
            path: st2-entrypointd-fs-env


---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2resultstracker
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2resultstracker
    spec:
      containers:
      - name: st2resultstracker
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2resultstracker
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2notifier
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2notifier
    spec:
      containers:
      - name: st2notifier
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2notifier
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2garbagecollector
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2garbagecollector
    spec:
      containers:
      - name: st2garbagecollector
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2garbagecollector
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: mistral-api
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: mistral-api
    spec:
      containers:
      - name: mistral-api
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: mistral-api
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }
        ports:
        - containerPort: 8989

---
kind: Service
apiVersion: v1
metadata:
  name: mistral-api
  namespace: st2stack
spec:
  selector:
    app: mistral-api
  ports:
  - protocol: TCP
    port: 8989

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: mistral-server
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: mistral-server
    spec:
      containers:
      - name: mistral-server
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: mistral-server
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: st2web
  namespace: st2stack
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: st2web
    spec:
      containers:
      - name: st2web
        image: stackstorm/stackstorm:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: ST2_SERVICE
          value: st2web
        envFrom:
        - configMapRef: { name: st2 }
        - configMapRef: { name: rabbitmq }
        - configMapRef: { name: postgres }
        ports:
        - containerPort: 443
      - name: dns-resolver
        image: janeczku/go-dnsmasq:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: DNSMASQ_ENABLE_SEARCH
          value: "1"
        ports:
        - containerPort: 53
          protocol: UDP

---
kind: Service
apiVersion: v1
metadata:
  name: st2web
  namespace: st2stack
spec:
  selector:
    app: st2web
  #type: NodePort
  type: LoadBalancer
  ports:
  - protocol: TCP
    port: 443
    targetPort: 443

